<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>耗材目录</title>
    <link rel="stylesheet" href="../../lib/layui-v2.6.3/css/layui.css">
    <link rel="stylesheet" href="../../css/public.css">
    <script src="../../lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
    <script src="../../lib/layui-v2.6.3/layui.js"></script>
    <style>
        #button_bottom {
            position: relative;
            width: 100%;
        }

        #timeShow {
            background: #449FFF;
            text-align: center;
            line-height: 38px;
            color: black;
            font-size: 16px;
            width: 300px;
            height: 38px;
            border: 1px solid red;
            border-radius: 12px;
            position: absolute;
            /*left:860px;*/
            margin-left: 15px;
        }

    </style>
</head>
<body>
<div class="layuimini-container">
    <fieldset class="table-search-fieldset" style="position: relative">
        <legend>搜索信息</legend>
        <div class="layui-form-item" style="margin:10px">
            <div class="layui-form layui-form-pane">
                <div class="layui-input-inline">
                    <input class="layui-input" id="name" placeholder="请输耗材名称" type="text">
                </div>
                <div class="layui-inline" id="departmentdiv">
                    <select id="department" name="department">
                        <option value="">部门</option>
                        <option value="智慧学院">智慧学院</option>
                        <option value="机电学院">机电学院</option>
                        <option value="艺术学院">艺术学院</option>
                        <option value="康养学院">康养学院</option>
                        <option value="建筑学院">建筑学院</option>
                        <option value="旅游学院">旅游学院</option>
                        <option value="交通学院">交通学院</option>
                        <option value="经贸学院">经贸学院</option>
                        <option value="教育学院">教育学院</option>
                        <option value="酒店学院">酒店学院</option>
                        <option value="电商学院">电商学院</option>
                        <option value="国际学院">国际学院</option>
                        <option value="海大航海学院">海大航海学院</option>

                    </select>
                </div>
                <div class="layui-inline">
                    <select id="attribute" name="attribute">
                        <option value="">耗材属性</option>
                        <option value="1">低值易耗品</option>
                        <option value="2">低值耐用品</option>
                    </select>
                </div>
                <div class="layui-inline">
                    <select id="type" name="type">
                        <option value="">耗材类别</option>
                        <option value="1">酒店食品</option>
                        <option value="2">金属材料</option>
                        <option value="3">电子电器</option>
                        <option value="4">建筑材料</option>
                        <option value="5">服装服饰</option>
                        <option value="6">文化绘画</option>
                        <option value="7">工作仪表</option>
                        <option value="8">化工药品</option>
                        <option value="9">气体类</option>
                        <option value="10">维修保养</option>
                        <option value="11">其他</option>
                    </select>
                </div>
                <div class="layui-inline">
                    <select id="status" name="status">
                        <option value="">审核状态</option>
                        <option value="0">未提交</option>
                        <option value="1">已通过</option>
                        <option value="2">被退回</option>
                        <option value="3">审核中</option>
                    </select>
                </div>
                <div class="layui-inline" id="majornamediv">
                    <select id="majorname" name="majorname" lay-filter="major">
                        <option value="">请选择专业</option>
                    </select>
                </div>
                <div class="layui-inline" id="coursenamediv">
                    <select id="coursename" name="coursename">
                        <option value="">请选择课程</option>
                    </select>
                </div>

                <button class="layui-btn layui-btn-normal" id="search" name="search" type="button"><i
                        class="layui-icon"></i>查询
                </button>
                <div id="button_bottom">
                    <button class="layui-btn layui-btn-normal" id="add" name="add" type="button"><i
                            class="layui-icon layui-icon-addition"></i>添加
                    </button>
                    <a href="/consumableslist/downloadExcel" class="layui-btn layui-btn-normal"><i class="layui-icon">&#xe67d;</i>模板下载</a>
                    <button id="btnExp" class="layui-btn layui-btn-normal"><i class="layui-icon">&#xe67d;</i>导出
                    </button>
                    <button id="excelImport" class="layui-btn layui-btn-normal">
                        <i class="layui-icon">&#xe67c;</i>导入excel并展示
                    </button>
                    <button class="layui-btn layui-btn-normal" id="timeSetting" name="timeSetting" type="button">
                        设置维护开放日期
                    </button>
                    <button class="layui-btn  layui-btn-normal" id="showOpinion" name="showOpinion" type="button">
                        查看审核意见
                    </button>
                    <button class="layui-btn  layui-btn-normal" id="showData" name="showData" type="button">查看详情
                    </button>
                    <button class="layui-btn  layui-btn-normal" id="auditorSubmit" name="auditorSubmit" type="button">
                        提交审核
                    </button>
                    <button class="layui-btn  layui-btn-danger" id="deleteData" name="deleteData" type="button">
                        批量删除
                    </button>
                    <span id="timeShow" name="timeShow" class="layui-inline"></span>
                </div>
            </div>
        </div>
    </fieldset>

    <table class="layui-hide" id="demo" lay-filter="test"></table>

</div>
<script id="barDemo" type="text/html">
    <a class="layui-btn layui-btn-sm" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del">删除</a>
</script>
<script id="re-modify" type="text/html">
    <a class="layui-btn layui-btn-sm" lay-event="modify">重新修改</a>
    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del">删除</a>
</script>
</body>

<script>

    //加载模块
    layui.use(['form', 'table', 'laydate'], function () { //亦可加载特定模块：layui.use(['layer', 'laydate', function(){
        //得到各种内置组件
        var layer = layui.layer //弹层
            , laypage = layui.laypage //分页
            , laydate = layui.laydate //日期
            , table = layui.table //表格
            , form = layui.form
            , upload = layui.upload
            , util = layui.util;

        var consumList = {
            tableId: 'demo',
            condition: {
                name: '',
                department: '',
                review_id: '',
                attribute: '',
                type: '',
                status: '',
                unit: '',
                number: '',
                training: '',
                opinion: '',
                auditor: '',
                no: '',
                majorname: '',
                coursename: ""
            }
        }

        //查询当前用户登录信息用于权限控制
        var name = "", //姓名
            role = "", //职位
            department = "", //学院
            initMajor = '';//专业负责人默认选中专业

        window.onload = function () {
            $("#timeSetting").hide();
            $("#majornamediv").hide();
            $("#coursenamediv").hide();
            $("#excelImport").hide();
            $("#add").hide();
            $("#auditorSubmit").hide();
            $("#deleteData").hide();
            $("#departmentdiv").hide();
            $.ajax({
                type: "post",
                url: "/consumableslist/userData",
                data: "",
                datatype: "json",
                success: function (msg) {
                    console.log("角色为" + msg.data.role)
                    role = msg.data.role;
                    name = msg.data.name;
                    department = msg.data.department;
                    //根据用户信息取消其不具有的权限操作
                    switch (role) {
                        case "专业负责人":
                            $("#add").show();
                            $("#excelImport").show();
                            $("#auditorSubmit").show();
                            $("#deleteData").show();
                            $("#majornamediv").show();
                            $("#majorname").val(initMajor)
                            layui.form.render("select");
                            consumList.search();
                            break;
                        case "二级学院管理员":
                            $("#deleteData").show();
                            $("#majornamediv").show();
                            // $("#coursenamediv").show();
                            break;
                        case "二级学院教学院长":
                            $("#excelImport").hide();
                            $("#add").hide();
                            break;
                        case "教务处管理员":
                            // $("#add").show();
                            // $("#excelImport").show();
                            $("#timeSetting").show();
                            $("#auditorSubmit").show();
                            $("#deleteData").show();
                            $("#departmentdiv").show();
                            // $("#majornamediv").show();
                            break;
                        case "超级管理员":
                            $("#timeSetting").show();
                            $("#deleteData").show();
                            $("#departmentdiv").show();
                            $("#excelImport").hide();
                            $("#add").hide();
                            break;
                        case "督导员":
                            $("#departmentdiv").show();
                            $("#excelImport").hide();
                            $("#add").hide();
                            break;
                    }
                }
            });


        }


        //维护权限控制
        selectTime();
        var endTime = ""
        var startTime = ""

        function selectTime() {
            $.ajax({
                type: "post",
                url: "/consumableslist/selectTimeResult",
                data: "",
                datatype: "json",
                success: function (msg) {
                    endTime = new Date(msg.data.endTime).getTime()
                    startTime = new Date(msg.data.beginTime).getTime();
                    var nowTime = new Date().getTime();
                }
            });
        }


        function initTable() {
            //执行一个 table 实例
            //渲染表格初始化
            table.render({
                elem: '#demo'
                , height: 530
                , url: '/consumableslist/getAllConsumablesList' //数据接口
                , title: '耗材目录'
                , page: true //开启分页
                , totalRow: true //开启合计行
                , cols: [[ //表头
                    {type: 'checkbox', fixed: 'left'}
                    , {field: 'id', title: 'ID', sort: true, fixed: 'left', totalRowText: '合计：', hide: 'true'}
                    , {field: 'review_id', title: '审核编号', hide: 'true'}
                    , {field: 'name', title: '耗材名称', event: 'seepage'}
                    , {field: 'attribute', title: '耗材属性'}
                    , {field: 'type', title: '类别'}
                    , {field: 'standards', title: '规格'}
                    , {field: 'no', title: '耗材编码', hide: 'true'}
                    , {field: 'unit', title: '单位', width: 60}
                    , {field: 'price', title: '单价'}
                    , {field: 'number', title: '生均数量', width: 90}
                    , {field: 'training', title: '实训项目'}
                    , {field: 'department', title: '学院', width: 90}
                    , {
                        field: 'status', title: '审核状态', width: 90,
                        templet: function (res) {
                            switch (res.status) {
                                case '审核中':
                                    return '<span style="color:#0096ef;" class="sbwc_background">审核中</span>';
                                case '通过':
                                    return '<span style="color:green;" class="sbwc_background">已通过</span>';
                                case '未提交':
                                    return '<span style="color:#7d65d3;" class="sbwc_background">未提交</span>';
                                case '被退回':
                                    return '<span style="color:#d0263f;" class="sbwc_background">被退回</span>';
                            }
                        }
                    }
                    , {
                        field: 'status_z', title: '审核进度', width: 156,
                        templet: function (res) {
                            switch (res.status_z) {
                                case '0':
                                    return '未提交';
                                case '1':
                                    return '学院管理员未审核';
                                case '2':
                                    return '学院院长未审核';
                                case '3':
                                    return '学院管理员退回';
                                case '4':
                                    return '教务处管理员未审核';
                                case '5':
                                    return '学院教学院长退回';
                                case '6':
                                    return '审核已通过';
                                case '7':
                                    return '教务处管理员退回';
                            }
                        }
                    }
                    , {field: 'auditor', title: '当前审核员', hide: 'true'}
                    , {field: 'opinion', title: '审核意见', hide: 'true'}
                    , {
                        fixed: 'right', width: 160, align: 'center', templet: function (res) {
                            if (role.indexOf("专业负责人") != -1) {
                                if (res.status != "被退回") {
                                    return '<a class="layui-btn layui-btn-sm" lay-event="edit">编辑</a>\n' +
                                        '    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del">删除</a>'
                                } else {
                                    return '    <a class="layui-btn layui-btn-sm layui-btn-warm" lay-event="modify" >重新修改</a>\n' +
                                        '    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del">删除</a>'
                                }
                            } else {
                                return '<a class="layui-btn layui-btn-sm" lay-event="edit">编辑</a>\n' +
                                    '    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del">删除</a>'
                            }
                        }
                    }
                ]]
                , parseData: function (res) {
                    return {
                        "code": res.status == 1 ? 0 : res.status,//解析接口状态
                        "msg": res.message, //解析提示文本
                        "count": res.data.count, //解析数据长度
                        "data": res.data.list //解析数据列表
                    };

                }
            });
        }

        //初始化表格
        initTable();


        //专业查询(对二级学院管理员开放的)
        function initGetCourseMajor() {
            $.ajax({
                type: "post",
                url: "/consumableslist/getCourseMajor",
                data: "",
                datatype: "json",
                success: function (msg) {
                    let majorList = [];
                    if (msg.status == "1") {
                        for (var index of msg.data) {
                            if (index != null) {
                                $("#majorname").append("<option value=" + index.major + ">" + index.major + "</option>");
                                majorList.push(index.major)
                            }
                        }
                    } else {
                        layer.msg('user-major_id字段请等待后台填充');
                    }
                    //动态下拉菜单的选中
                    initMajor = majorList[0]
                    form.render('select');
                },
                error: function (msg) {
                    alert("失败");
                }
            })
        }

        initGetCourseMajor();
        //实现联动查询专业对应下的课程
        form.on('select(major)', function (data) {
            $("#coursename").empty();
            $("#coursename").append("<option value=''>请选择课程</option>");
            var major = $("#majorname").val();
            $.ajax({
                url: "/consumableslist/getCourseName?major=" + major,
                type: "post",
                contentType: "application/json",
                dataType: "json",
                success: function (msg) {
                    if (msg.status == "1") {
                        for (var index of msg.data) {
                            $("#coursename").append("<option value=" + index.name + ">" + index.name + "</option>");
                        }
                    }
                    form.render('select')
                },
            })
        });


        // 搜索方法
        consumList.search = function () {
            var queryData = {};
            queryData['department'] = $('#department').val()
            queryData['name'] = $('#name').val()
            queryData['attribute'] = $('#attribute').val()
            queryData['type'] = $('#type').val()
            queryData['status'] = $('#status').val()
            queryData['major'] = $('#majorname').val()
            table.reload(consumList.tableId, {
                where: queryData, page: {curr: 1}
            })
        }
        //绑定查询按钮
        $("#search").on("click", function () {
            consumList.search();
        })


        //监听行工具事件
        table.on('tool(test)', function (obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data //获得当前行数据
                , layEvent = obj.event; //获得 lay-event 对应的值
            if (layEvent === 'seepage') {

            } else if (layEvent === 'edit') {
                var nowTime = new Date().getTime();

                if (role.indexOf("督导员") != -1) {
                    layer.msg('抱歉无权限', {icon: 2, time: 2000, anim: 6})
                    return false;
                }

                if (role.indexOf("专业负责人") != -1 || role.indexOf("二级学院管理员") != -1 || role.indexOf("二级学院教学院长") != -1) {
                    if (nowTime < startTime) {
                        layer.msg('未到开放时间', {icon: 2, time: 2000, anim: 6})
                        return false;
                    } else if (nowTime > endTime) {
                        layer.msg('维护时间已过', {icon: 2, time: 2000, anim: 6})
                        return false
                    }
                }
                if (role.indexOf("专业负责人") != -1) {
                    if (data.status === "审核中") {
                        layer.msg('正在审核无法修改', {icon: 2, time: 2000, anim: 6})
                        return false;
                    } else if (data.status === "被退回") {
                        layer.msg('请重新刷新页面', {icon: 2, time: 3000, anim: 6})
                        return false;
                    }
                }
                if (role.indexOf("二级学院管理员") != -1) {
                    if (data.status === "审核中") {
                        layer.msg('正在审核无法修改', {icon: 2, time: 2000, anim: 6})
                        return false;
                    } else if (data.status === "通过") {
                        layer.msg('已通过无法修改', {icon: 2, time: 2000, anim: 6})
                        return false;
                    } else if (data.status === "未提交") {
                        if (role.indexOf("专业负责人") == -1) {
                            layer.msg('没有权限', {icon: 2, time: 2000, anim: 6})
                            return false;
                        }
                    } else if (data.status === "被退回") {
                        layer.msg('当前项目已被退回,无法修改', {icon: 2, time: 3000, anim: 6})
                        return false;
                    }
                }
                //layer.msg('编辑操作');
                layui.sessionData('editId', {key: 'id', value: data.id})
                layer.open({
                    type: 2,
                    shadeClose: false,
                    content: '/page/consumablesListEdit',
                    area: ['600px', '600px'],
                    end: function () {
                        table.reload('demo');
                    }
                })
            } else if (layEvent === 'modify') {
                //重新修改
                var nowTime = new Date().getTime();
                if (nowTime < startTime) {
                    layer.msg('未到开放时间', {icon: 2, time: 2000, anim: 6})
                    return false;
                } else if (nowTime > endTime) {
                    layer.msg('维护时间已过', {icon: 2, time: 2000, anim: 6})
                    return false
                }

                layui.sessionData('editId', {key: 'id', value: data.id})
                layer.open({
                    type: 2,
                    shadeClose: false,
                    content: '/page/consumablesListModify',
                    area: ['600px', '600px'],
                    end: function () {
                        table.reload('demo');
                    }
                })

            } else if (layEvent === 'del') {
                var nowTime = new Date().getTime();
                if (role.indexOf("督导员") != -1) {
                    layer.msg('抱歉无权限', {icon: 2, time: 2000, anim: 6})
                    return false;
                }
                if (role.indexOf("专业负责人") != -1 || role.indexOf("二级学院管理员") != -1 || role.indexOf("二级学院教学院长") != -1) {
                    if (nowTime < startTime) {
                        layer.msg('未到开放时间', {icon: 2, time: 2000, anim: 6})
                        return false;
                    } else if (nowTime > endTime) {
                        layer.msg('维护时间已过', {icon: 2, time: 2000, anim: 6})
                        return false
                    }
                }
                if (role.indexOf("专业负责人") != -1) {
                    if (data.status === "审核中") {
                        layer.msg('正在审核无法删除', {icon: 2, time: 2000, anim: 6})
                        return false
                    }
                }
                if (role.indexOf("二级学院管理员") != -1 || role.indexOf("二级学院教学院长") != -1) {
                    if (data.status === "审核中") {
                        layer.msg('正在审核无法删除', {icon: 2, time: 2000, anim: 6})
                        return false
                    } else if (data.status === "未提交") {
                        layer.msg('没有权限', {icon: 2, time: 2000, anim: 6})
                        return false
                    } else if (data.status === "通过") {
                        layer.msg('已通过无法删除', {icon: 2, time: 2000, anim: 6})
                        return false
                    } else if (data.status === "被退回") {
                        layer.msg('没有权限', {icon: 2, time: 2000, anim: 6})
                        return false;
                    }
                }
                layer.confirm('真的删除行么', function (index) {
                    var sendData = {
                        "id": data.id,
                        "review_id": data.review_id
                    }
                    $.ajax({
                        type: "post",
                        url: "/consumableslist/deleteData",
                        data: sendData,
                        datatype: "json",
                        success: function (msg) {
                            if (msg.status == "1") {
                                layer.msg('删除成功');
                                table.reload('demo', {
                                    page: {
                                        curr: 1
                                    }
                                });
                            } else {
                                layer.msg('删除失败');
                            }
                        },
                        error: function (msg) {
                            alert("失败");
                        }
                    });
                    obj.del(); //删除对应行（tr）的DOM结构
                    layer.close(index);
                    //向服务端发送删除指令
                });
            }
        });

        //分页
        laypage.render({
            elem: 'pageDemo' //分页容器的id
            , count: 1000 //数据总数
            , limit: 10 //每页显示的数据条数
            , skin: '#1E9FFF' //自定义选中色值
            //,layout: ['prev', 'page', 'next', 'count', 'limit', 'refresh', 'skip'] //自定义排版
            , jump: function (obj, first) {
                if (!first) {
                    layer.msg('第' + obj.curr + '页', {offset: 'b'});
                }
            }
        });


        //添加数据
        $("#add").on("click", function () {
            // var nowTime = new Date().getTime();
            // if(nowTime<startTime){
            //     layer.msg('未到开放时间',{ icon: 2, time:2000, anim:6 })
            //     return false;
            // }else if (nowTime>endTime){
            //     layer.msg('维护时间已过',{ icon: 2, time:2000, anim:6 })
            //     return false
            // }

            layer.open({
                type: 2,
                shadeClose: false,
                content: '/page/consumablesListAdd',
                area: ['600px', '600px'],
                end: function () {
                    table.reload('demo');
                }
            })
        })


        // 导出选中行数据excel
        consumList.exportData = function () {
            var res = table.checkStatus('demo')
            if (res.data.length === 0) {
                layer.msg('请选择导出内容', {icon: 2, time: 2000, anim: 6})
            } else {
                table.exportFile(consumList.tableId, res.data, 'xls')
            }
        }
        // 导出excel绑定按钮
        $("#btnExp").on("click", function () {
            consumList.exportData();
        })


        //审核提交
        consumList.auditorSubmit = function () {

            var res = table.checkStatus('demo')
            console.log(JSON.stringify(res.data))
            var projectName = [];
            var review_id = [];
            var department = "";
            res.data.forEach(function (value, index) {
                console.log(index, value,);
                projectName[index] = value.name;
                review_id[index] = value.review_id;
                department = value.department;
            })
            for (i = 0; i < res.data.length; i++) {
                console.log(projectName[i] + "++++" + review_id[i])
            }
            layui.sessionData("projectName", {
                key: 'projectName',
                value: projectName
            })
            layui.sessionData("review_id", {
                key: 'review_id',
                value: review_id
            })
            layui.sessionData("department", {
                key: 'department',
                value: department
            })

            if (res.data.length === 0) {
                layer.msg('请选择要提交的内容', {icon: 2, time: 2000, anim: 6})
                return false;
            } else if (res.data.length === 1) {
                var dataId = "";
                var status = "";//审核状态
                for (index of res.data) {
                    dataId = index.id;
                    status = index.status;
                }
                if (status === "审核中") {
                    layer.msg('审核已提交,请勿重复提交', {icon: 2, time: 2000, anim: 6})
                    return false;
                } else if (status === "通过") {
                    layer.msg('审核已通过,无需再次提交', {icon: 2, time: 2000, anim: 6})
                    return false;
                } else if (status == "被退回") {
                    layer.msg('请点击"重新修改"按钮进行单个项目的提交', {icon: 2, time: 3000, anim: 6})
                    return false;
                }
                layer.open({
                    type: 2,
                    title: "目录审核",
                    shadeClose: false,
                    content: '/page/consumablesListAuditSubmit',
                    area: ['1200px', '500px'],
                    end: function () {
                        table.reload('demo');
                    }
                })
                return false;
            } else if (res.data.length > 1) {
                var hasRejected = false; // 是否存在被退回的数据
                var hasUnsubmitted = false; // 是否存在未提交的数据

                for (var i = 0; i < res.data.length; i++) {
                    // if (res.data[i].status == "通过" || res.data[i].status == "被退回" || res.data[i].status == "审核中") {
                    //     layer.msg('选择的数据中存在"已通过","被退回","审核中"的数据，请取消勾选', {
                    //         icon: 2,
                    //         time: 2000,
                    //         anim: 6
                    //     })
                    //     return false
                    // }
                    if (res.data[i].status == "通过" || res.data[i].status == "审核中") {
                        layer.msg('选择的数据中存在"已通过","审核中"的数据，请取消勾选', {
                            icon: 2,
                            time: 2000,
                            anim: 6
                        })
                        return false
                    }
                    if (res.data[i].status == "被退回") {
                        hasRejected = true;
                    } else if (res.data[i].status == "未提交") {
                        hasUnsubmitted = true;
                    }
                }
                if (hasRejected && hasUnsubmitted) {
                    layer.msg('选择的数据中同时存在"被退回"和"未提交"的数据，请取消勾选其中一种', {
                        icon: 2,
                        time: 2000,
                        anim: 6
                    });
                    return false;
                }
                if (hasRejected && !hasUnsubmitted) {
                    layer.confirm('确定将批量已退回的数据重新提交吗？', {
                        btn: ['确定', '取消']
                    }, function () {
                        console.log(review_id)
                        $.ajax({
                            type: "post",
                            url: "/consumableslist/quantityModifyConsumablesList",
                            data: {data: JSON.stringify(review_id)}, // 修改为reviewIds
                            datatype: "json",
                            success: function () {
                                layer.msg('批量提交成功', {
                                    icon: 1,
                                    time: 2000,
                                    anim: 6,
                                    end: function () { // 消息显示完成后的回调函数
                                        table.reload('demo');
                                        layer.closeAll(); // 关闭弹窗
                                    }
                                });
                            }
                        });

                    }, function () {
                        return true; // 允许关闭弹窗
                    });
                    return false;
                }

                if (!hasRejected && hasUnsubmitted) {
                    layer.open({
                        type: 2,
                        title: "目录审核",
                        shadeClose: false,
                        content: '/page/consumablesListAuditSubmit',
                        area: ['1200px', '500px'],
                        end: function () {
                            table.reload('demo');
                        }
                    })
                    return false;
                }
            }
        }
        //审核提交绑定
        $("#auditorSubmit").on("click", function () {
            var nowTime = new Date().getTime();
            if (nowTime < startTime) {
                layer.msg('未到开放时间', {icon: 2, time: 2000, anim: 6})
                return false;
            } else if (nowTime > endTime) {
                layer.msg('维护时间已过', {icon: 2, time: 2000, anim: 6})
                return false
            }
            consumList.auditorSubmit();
        })


        //上传录入数据 excel
        var uploadInst = upload.render({
            elem: '#excelImport' //绑定元素
            , url: '/consumableslist/importExcel' //上传接口
            , accept: 'file'
            , done: function (msg) {
                console.log(msg);               //上传完毕回调
                if (msg.status === "0") {
                    layer.open({
                        type: 1
                        ,
                        title: '含有错误数据，需要下载查看重新导入'
                        ,
                        area: ['300px', '300px']
                        ,
                        shade: 0.8
                        ,
                        id: 'LAY_layuipro' //设定一个id，防止重复弹出
                        ,
                        btnAlign: 'c'
                        ,
                        moveType: 1 //拖拽模式，0或者1
                        ,
                        content: '<a href="/consumableslist/downloadErrorExcel" class="layui-btn layui-btn-normal" style="margin:20px"><i class="layui-icon">&#xe67d;</i>下载错误数据</a>',
                    })
                }
                if (msg.status === "2") {
                    layer.msg(msg.message, {icon: 2, time: 8000, anim: 6})
                } else {
                    layer.msg("导入成功")
                    table.reload(consumList.tableId);
                }
            }
            , error: function () {
                layer.msg("数据异常,请核对后再次上传");
                table.reload(consumList.tableId);
            }
        });


        //页面显示维护时间倒计时
        showTime();

        function showTime() {
            $.ajax({
                type: "post",
                url: "/consumableslist/selectTimeResult",
                data: "",
                datatype: "json",
                success: function (msg) {
                    var endTime = new Date(msg.data.endTime).getTime();
                    var startTime = new Date(msg.data.beginTime).getTime();
                    var serverTime = new Date().getTime();
                    if (serverTime < startTime) {
                        $('#timeShow').text("维护未开始");
                        return false;
                    } else if (serverTime > endTime) {
                        $('#timeShow').text("维护已结束");
                        return false;
                    } else {
                        util.countdown(endTime, serverTime, function (date, serverTime, timer) {
                            var str = date[0] + '天' + date[1] + '时' + date[2] + '分' + date[3] + '秒'
                            $('#timeShow').text('维护剩余时间：' + str);
                        });
                    }

                }
            });
        }

        //维护时间设定
        $("#timeSetting").on("click", function () {
            layer.open({
                type: 2,
                shadeClose: false,
                content: '/page/consumablesListTime',
                area: ['650px', '500px'],
                end: function (index, layero) {
                    selectTime();
                    showTime();
                    window.location.reload()
                }
            })
        })

        //查看退回意见
        consumList.showOpinion = function () {
            var res = table.checkStatus('demo');
            if (res.data.length === 0) {
                layer.msg('请选择要查看退回意见的数据', {icon: 2, time: 2000, anim: 6})
            } else if (res.data.length > 1) {
                layer.msg('一次仅可以选择一条数据', {icon: 2, time: 2000, anim: 6})
            } else {
                for (index of res.data) {
                    var opinion = index.opinion;
                }
                layer.open({
                    type: 1
                    ,
                    title: '退回意见'
                    ,
                    area: ['550px', '220px']
                    ,
                    shade: 0.8
                    ,
                    id: 'LAY_layuipro' //设定一个id，防止重复弹出
                    ,
                    btnAlign: 'c'
                    ,
                    moveType: 1 //拖拽模式，0或者1
                    ,
                    content: '<textarea id="opinion" placeholder="请输入退回意见" class="layui-textarea">' + opinion + '</textarea>',
                })

            }

        }
        //查看退回意见按钮绑定
        $("#showOpinion").on("click", function () {
            consumList.showOpinion();
        })

        //查看详情
        consumList.showData = function () {
            var res = table.checkStatus('demo');
            if (res.data.length === 0) {
                layer.msg('请选择要查看详情的数据', {icon: 2, time: 2000, anim: 6})
            } else if (res.data.length > 1) {
                layer.msg('一次仅可以选择一条数据', {icon: 2, time: 2000, anim: 6})
            } else {
                for (index of res.data) {
                    var name = index.name;
                    var no = index.no;
                    var attribute = index.attribute;
                    var type = index.type;
                    var standards = index.standards;
                    var unit = index.unit;
                    var price = index.price;
                    var number = index.number;
                    var training = index.training;
                    var department = index.department;
                }
                layer.open({
                    type: 1
                    , title: '耗材详情'
                    , area: ['400px', '500px']
                    , shade: 0.8
                    , id: 'LAY_layuipro' //设定一个id，防止重复弹出
                    , btnAlign: 'c'
                    , moveType: 1 //拖拽模式，0或者1
                    , content: '<div style="margin: 10px">' +
                        '<p style="margin-top: 10px">耗材名称:' + name + '</p>' +
                        '<p style="margin-top: 10px">编码:' + no + '</p>' +
                        '<p style="margin-top: 10px">耗材属性:' + attribute + '</p>' +
                        '<p style="margin-top: 10px">耗材类别:' + type + '</p>' +
                        '<p style="margin-top: 10px">耗材规格:' + standards + '</p>' +
                        '<p style="margin-top: 10px">耗材单位:' + unit + '</p>' +
                        '<p style="margin-top: 10px">耗材价格:' + price + '</p>' +
                        '<p style="margin-top: 10px">生均数量:' + number + '</p>' +
                        '<p style="margin-top: 10px">实训项目:' + training + '</p>' +
                        '<p style="margin-top: 10px">学院:' + department + '</p>' +
                        '</div>',
                })

            }

        }

        //查看详情按钮绑定
        $("#showData").on("click", function () {
            consumList.showData();
        })


        //批量删除
        consumList.deleteData = function () {
            var checkStatus = table.checkStatus('demo');
            if (checkStatus.data.length > 0) {

                if (role.indexOf("专业负责人") != -1 || role.indexOf("二级学院管理员") != -1 || role.indexOf("二级学院教学院长") != -1) {
                    for (var i = 0; i < checkStatus.data.length; i++) {
                        if (checkStatus.data[i].status == "通过" || checkStatus.data[i].status == "审核中") {
                            layer.msg('选择的数据中存在已通过或审核中的数据不可删除，请取消勾选', {
                                icon: 2,
                                time: 2000,
                                anim: 6
                            })
                            return false
                        }
                    }
                }

                //获取所选择要删除的数据
                var review_ids = [];
                for (var i = 0; i < checkStatus.data.length; i++) {
                    review_ids.push(checkStatus.data[i].review_id)
                }
                var reviewIds = review_ids.toString();
                var sendData = {
                    "review_ids": reviewIds
                }
                layer.confirm('真的删除行么', function (index) {
                    $.ajax({
                        type: "post",
                        url: "/consumableslist/deleteSelectData",
                        data: sendData,
                        datatype: "json",
                        success: function (msg) {
                            if (msg.status == 1) {
                                layer.msg('删除成功', {icon: 6, time: 2000, anim: 6})
                                table.reload('demo');
                            } else {
                                layer.msg('删除失败', {icon: 2, time: 2000, anim: 6})
                                table.reload('demo');
                            }
                        },
                        error: function (msg) {
                            layer.msg('服务器错误', {icon: 2, time: 2000, anim: 6})
                            table.reload('demo');
                        }

                    })
                })


            } else {
                layui.layer.alert("请至少选择一行");
            }
        };

        //批量审核按钮绑定
        $("#deleteData").on("click", function () {
            var nowTime = new Date().getTime();
            if (role.indexOf("专业负责人") != -1 || role.indexOf("二级学院管理员") != -1 || role.indexOf("二级学院教学院长") != -1) {
                if (nowTime < startTime) {
                    layer.msg('未到开放时间', {icon: 2, time: 2000, anim: 6})
                    return false;
                } else if (nowTime > endTime) {
                    layer.msg('维护时间已过', {icon: 2, time: 2000, anim: 6})
                    return false
                }
            }
            consumList.deleteData();
        })
    });
</script>
</html>